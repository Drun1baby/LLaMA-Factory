<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®è°ƒæ¨¡å‹æµ‹è¯• - Hunyuan-7B LoRA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¤– å¾®è°ƒæ¨¡å‹æµ‹è¯•</h1>
            <p class="subtitle">Hunyuan-7B-Instruct + LoRA é€‚é…å™¨</p>
        </header>

        <div class="status-bar">
            <span class="status-label">æ¨¡å‹çŠ¶æ€ï¼š</span>
            <span id="model-status" class="status-value">æ£€æŸ¥ä¸­...</span>
            <button id="load-model-btn" class="btn btn-secondary" style="display: none;">åŠ è½½æ¨¡å‹</button>
        </div>

        <main>
            <div class="chat-container">
                <div class="settings-panel">
                    <h3>âš™ï¸ ç”Ÿæˆå‚æ•°</h3>
                    <div class="setting-item">
                        <label for="use-streaming">
                            <input type="checkbox" id="use-streaming" checked>
                            å¯ç”¨æµå¼è¾“å‡ºï¼ˆè¾¹ç”Ÿæˆè¾¹æ˜¾ç¤ºï¼‰
                        </label>
                    </div>
                    <div class="setting-item">
                        <label for="max-tokens">æœ€å¤§ç”Ÿæˆé•¿åº¦</label>
                        <input type="number" id="max-tokens" value="256" min="1" max="2048">
                    </div>
                    <div class="setting-item">
                        <label for="temperature">Temperature (åˆ›é€ æ€§): <span id="temp-value">0.7</span></label>
                        <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7">
                    </div>
                    <div class="setting-item">
                        <label for="top-p">Top-P: <span id="top-p-value">0.9</span></label>
                        <input type="range" id="top-p" min="0" max="1" step="0.05" value="0.9">
                    </div>
                </div>

                <div class="chat-panel">
                    <div id="chat-messages" class="chat-messages">
                        <div class="message system-message">
                            <p>æ¬¢è¿ä½¿ç”¨å¾®è°ƒæ¨¡å‹æµ‹è¯•å·¥å…·ï¼åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œç‚¹å‡»å‘é€å³å¯æµ‹è¯•æ¨¡å‹æ•ˆæœã€‚</p>
                        </div>
                    </div>

                    <div class="input-area">
                        <textarea id="user-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–æç¤ºè¯..." rows="3"></textarea>
                        <div class="input-actions">
                            <button id="send-btn" class="btn btn-primary">
                                <span class="btn-text">å‘é€</span>
                                <span class="btn-loading" style="display: none;">ç”Ÿæˆä¸­...</span>
                            </button>
                            <button id="clear-btn" class="btn btn-secondary">æ¸…ç©ºå¯¹è¯</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>åŸºäº LLaMA-Factory å¾®è°ƒçš„æ¨¡å‹ | Powered by Flask</p>
        </footer>
    </div>

    <script>
        // DOM å…ƒç´ 
        const modelStatus = document.getElementById('model-status');
        const loadModelBtn = document.getElementById('load-model-btn');
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const clearBtn = document.getElementById('clear-btn');
        const useStreaming = document.getElementById('use-streaming');
        const maxTokens = document.getElementById('max-tokens');
        const temperature = document.getElementById('temperature');
        const topP = document.getElementById('top-p');
        const tempValue = document.getElementById('temp-value');
        const topPValue = document.getElementById('top-p-value');

        // æ›´æ–°æ»‘å—æ˜¾ç¤ºå€¼
        temperature.addEventListener('input', () => {
            tempValue.textContent = temperature.value;
        });
        topP.addEventListener('input', () => {
            topPValue.textContent = topP.value;
        });

        // æ£€æŸ¥æ¨¡å‹çŠ¶æ€
        async function checkModelStatus() {
            try {
                const response = await fetch('/api/model_status');
                const data = await response.json();
                
                if (data.loaded) {
                    modelStatus.textContent = 'å·²åŠ è½½ âœ“';
                    modelStatus.className = 'status-value status-loaded';
                    loadModelBtn.style.display = 'none';
                } else {
                    modelStatus.textContent = 'æœªåŠ è½½';
                    modelStatus.className = 'status-value status-unloaded';
                    loadModelBtn.style.display = 'inline-block';
                }
            } catch (error) {
                modelStatus.textContent = 'è¿æ¥å¤±è´¥';
                modelStatus.className = 'status-value status-error';
            }
        }

        // åŠ è½½æ¨¡å‹
        loadModelBtn.addEventListener('click', async () => {
            loadModelBtn.disabled = true;
            loadModelBtn.textContent = 'åŠ è½½ä¸­...';
            modelStatus.textContent = 'åŠ è½½ä¸­...';
            
            try {
                const response = await fetch('/api/load_model', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    modelStatus.textContent = 'å·²åŠ è½½ âœ“';
                    modelStatus.className = 'status-value status-loaded';
                    loadModelBtn.style.display = 'none';
                    addMessage('system', 'æ¨¡å‹åŠ è½½æˆåŠŸï¼ç°åœ¨å¯ä»¥å¼€å§‹æµ‹è¯•äº†ã€‚');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                modelStatus.textContent = 'åŠ è½½å¤±è´¥';
                modelStatus.className = 'status-value status-error';
                addMessage('system', `æ¨¡å‹åŠ è½½å¤±è´¥: ${error.message}`);
            }
            
            loadModelBtn.disabled = false;
            loadModelBtn.textContent = 'åŠ è½½æ¨¡å‹';
        });

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessage(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.innerHTML = `<p>${escapeHtml(content)}</p>`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å‘é€æ¶ˆæ¯ï¼ˆæµå¼è¾“å‡ºï¼‰
        async function sendMessageStream(prompt, params) {
            // åˆ›å»ºä¸€ä¸ªç©ºçš„åŠ©æ‰‹æ¶ˆæ¯ç”¨äºæµå¼æ›´æ–°
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant-message';
            const contentP = document.createElement('p');
            messageDiv.appendChild(contentP);
            chatMessages.appendChild(messageDiv);
            
            let fullResponse = '';
            
            try {
                const response = await fetch('/api/chat_stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        ...params
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    // å°†æ–°æ•°æ®æ·»åŠ åˆ°ç¼“å†²åŒº
                    buffer += decoder.decode(value, { stream: true });
                    
                    // æŒ‰è¡Œåˆ†å‰²ï¼ˆSSE ä½¿ç”¨ \n\n åˆ†éš”æ¶ˆæ¯ï¼‰
                    const lines = buffer.split('\n');
                    
                    // ä¿ç•™æœ€åä¸€ä¸ªä¸å®Œæ•´çš„è¡Œ
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.slice(6).trim();
                                if (!jsonStr) continue;
                                
                                const data = JSON.parse(jsonStr);
                                
                                if (data.error) {
                                    addMessage('system', `é”™è¯¯: ${data.error}`);
                                    messageDiv.remove();
                                    return;
                                }
                                
                                if (data.token) {
                                    fullResponse += data.token;
                                    contentP.textContent = fullResponse;
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                }
                                
                                if (data.done) {
                                    return;
                                }
                            } catch (e) {
                                console.error('JSON è§£æé”™è¯¯:', e, 'Line:', line);
                            }
                        }
                    }
                }
            } catch (error) {
                addMessage('system', `è¯·æ±‚å¤±è´¥: ${error.message}`);
                messageDiv.remove();
            }
        }

        // å‘é€æ¶ˆæ¯ï¼ˆéæµå¼ï¼‰
        async function sendMessageNormal(prompt, params) {
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        ...params
                    })
                });

                const data = await response.json();

                if (data.success) {
                    addMessage('assistant', data.response);
                } else {
                    addMessage('system', `é”™è¯¯: ${data.error}`);
                }
            } catch (error) {
                addMessage('system', `è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        // å‘é€æ¶ˆæ¯ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
        async function sendMessage() {
            const prompt = userInput.value.trim();
            if (!prompt) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', prompt);
            userInput.value = '';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            sendBtn.querySelector('.btn-text').style.display = 'none';
            sendBtn.querySelector('.btn-loading').style.display = 'inline';
            sendBtn.disabled = true;

            // ç”Ÿæˆå‚æ•°
            const params = {
                max_new_tokens: parseInt(maxTokens.value),
                temperature: parseFloat(temperature.value),
                top_p: parseFloat(topP.value)
            };

            // æ ¹æ®å¼€å…³é€‰æ‹©æµå¼æˆ–éæµå¼
            if (useStreaming.checked) {
                await sendMessageStream(prompt, params);
            } else {
                await sendMessageNormal(prompt, params);
            }

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            sendBtn.querySelector('.btn-text').style.display = 'inline';
            sendBtn.querySelector('.btn-loading').style.display = 'none';
            sendBtn.disabled = false;
        }

        // æ¸…ç©ºå¯¹è¯
        clearBtn.addEventListener('click', () => {
            chatMessages.innerHTML = `
                <div class="message system-message">
                    <p>å¯¹è¯å·²æ¸…ç©ºï¼Œè¯·è¾“å…¥æ–°çš„é—®é¢˜ã€‚</p>
                </div>
            `;
        });

        // äº‹ä»¶ç›‘å¬
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ¨¡å‹çŠ¶æ€
        checkModelStatus();
    </script>
</body>
</html>
